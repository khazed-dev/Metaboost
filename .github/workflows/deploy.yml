name: ğŸš€ CI/CD MetaBoost

on:
  push:
    branches:
      - main
      - dev-*
      - feature/*
  pull_request:
    branches:
      - main

jobs:
  # Job 1: Check & Test (cháº¡y cho táº¥t cáº£ branches)
  check:
    name: ğŸ” Check & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âœ… Validate HTML files
        run: |
          echo "ğŸ” Checking HTML files..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "âœ“ $file exists"
            fi
          done
      
      - name: âœ… Check required files
        run: |
          echo "ğŸ” Checking project structure..."
          [ -d "assets/css" ] && echo "âœ“ CSS directory exists"
          [ -d "assets/js" ] && echo "âœ“ JS directory exists"
          [ -d "assets/img" ] && echo "âœ“ Images directory exists"
          [ -f "index.html" ] && echo "âœ“ index.html exists"
          [ -f "login.html" ] && echo "âœ“ login.html exists"
          echo "âœ… All checks passed!"

  # Job 2: Deploy (chá»‰ cháº¡y khi merge vÃ o main)
  deploy:
    name: ğŸŒ Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: check
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev-nhat') && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          # Write SSH key vá»›i proper newlines
          cat > ~/.ssh/deploy_key << 'EOL'
          ${{ secrets.VPS_SSH_KEY }}
          EOL
          chmod 600 ~/.ssh/deploy_key
          # ThÃªm host vÃ o known_hosts
          ssh-keyscan -H 103.110.33.94 >> ~/.ssh/known_hosts 2>/dev/null

      - name: ğŸ“¦ Deploy Frontend to VPS
        run: |
          # Sync frontend files (HTML, CSS, JS)
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            --exclude='*.sh' \
            --exclude='*.md' \
            *.html component/ assets/ \
            ${{ secrets.VPS_USER }}@103.110.33.94:/var/www/metaboost/Metaboost/

      - name: ğŸ”„ Restart Nginx (if needed)
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@103.110.33.94 "sudo systemctl reload nginx"

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Website: https://metaboost.duckdns.org"
          echo "ğŸ“… Deployed at: $(date)"

  # Job 3: Summary (luÃ´n cháº¡y Ä‘á»ƒ thÃ´ng bÃ¡o káº¿t quáº£)
  summary:
    name: ğŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [check, deploy]
    if: always()
    
    steps:
      - name: ï¿½ Workflow Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CI/CD Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo ""
          
          if [ "${{ needs.check.result }}" == "success" ]; then
            echo "âœ… Check & Validate: PASSED"
          else
            echo "âŒ Check & Validate: FAILED"
          fi
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "âœ… Deployment: SUCCESS"
              echo "ğŸŒ Live at: https://metaboost.duckdns.org"
            elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
              echo "â­ï¸  Deployment: SKIPPED (not main branch)"
            else
              echo "âŒ Deployment: FAILED"
            fi
          else
            echo "â„¹ï¸  Deployment: SKIPPED (only deploys on main)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
