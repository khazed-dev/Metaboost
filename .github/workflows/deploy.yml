name: "ğŸš€ CI/CD MetaBoost"

on:
  push:
    branches:
      - main
      - 'dev-*'
      - 'feature/*'
  pull_request:
    branches:
      - main

jobs:

  # ==========================================================
  # Job 1: CHECK & VALIDATE - cháº¡y cho táº¥t cáº£ cÃ¡c branch
  # ==========================================================
  check:
    name: "ğŸ” Check & Validate"
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "âœ… Validate HTML files"
        run: |
          echo "ğŸ” Checking HTML files in src/pages..."
          for file in src/pages/*.html; do
            if [ -f "$file" ]; then
              echo "âœ“ $file exists"
            fi
          done

      - name: "âœ… Check required directories"
        run: |
          echo "ğŸ” Checking project structure..."
          [ -d "src/assets/css" ] && echo "âœ“ CSS directory exists"
          [ -d "src/assets/js" ] && echo "âœ“ JS directory exists"
          [ -d "src/assets/img" ] && echo "âœ“ Images directory exists"
          [ -f "src/pages/index.html" ] && echo "âœ“ src/pages/index.html exists"
          [ -f "src/pages/login.html" ] && echo "âœ“ src/pages/login.html exists"
          echo "âœ… All checks passed!"

  # ==========================================================
  # Job 2: DEPLOY - chá»‰ cháº¡y khi push vÃ o main hoáº·c dev-nhat
  # ==========================================================
  deploy:
    name: "ğŸŒ Deploy to Production VPS"
    runs-on: ubuntu-latest
    needs: check
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev-nhat') && github.event_name == 'push'
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ” Setup SSH Key"
        run: |
          mkdir -p $HOME/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > $HOME/.ssh/deploy_key
          chmod 600 $HOME/.ssh/deploy_key
          ssh-keyscan -H 103.110.33.94 >> $HOME/.ssh/known_hosts 2>/dev/null

      - name: "ğŸ“¦ Deploy Frontend to VPS"
        run: |
          # ThÆ° má»¥c Ä‘Ã­ch chÃ­nh: /var/www/metaboost/Metaboost/
          TARGET_DIR="${{ secrets.VPS_USER }}@103.110.33.94:/var/www/metaboost/Metaboost/"
          SSH_OPTIONS="-e \"ssh -i $HOME/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=$HOME/.ssh/known_hosts\""
          EXCLUDE_OPTIONS="--exclude='.git' --exclude='node_modules' --exclude='.DS_Store' --exclude='*.sh' --exclude='*.md'"

          # 1. Äáº©y thÆ° má»¥c pages/ (chá»©a index.html) vÃ o thÆ° má»¥c Ä‘Ã­ch Metaboost/
          rsync -avz --delete $SSH_OPTIONS $EXCLUDE_OPTIONS \
            src/pages/ \
            ${TARGET_DIR}pages/

          # 2. Äáº©y thÆ° má»¥c assets/ (CSS, JS, IMG) vÃ o Metaboost/
          rsync -avz --delete $SSH_OPTIONS $EXCLUDE_OPTIONS \
            src/assets/ \
            ${TARGET_DIR}assets/

          # 3. Äáº©y thÆ° má»¥c component/ vÃ o Metaboost/
          rsync -avz --delete $SSH_OPTIONS $EXCLUDE_OPTIONS \
            src/component/ \
            ${TARGET_DIR}component/

          # XÃ³a cÃ¡c file bá»‹ Ä‘áº©y sai do láº§n deploy trÆ°á»›c (tuá»³ chá»n)
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@103.110.33.94 "sudo rm -rf /var/www/metaboost/Metaboost/css /var/www/metaboost/Metaboost/js /var/www/metaboost/Metaboost/img /var/www/metaboost/Metaboost/footer.html /var/www/metaboost/Metaboost/sidebar.html"

      - name: "ğŸ”„ Restart Nginx (if needed)"
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@103.110.33.94 "sudo systemctl reload nginx"

      - name: "âœ… Deployment Success"
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Website: https://metaboost.duckdns.org"
          echo "ğŸ“… Deployed at: $(date)"

  # ==========================================================
  # Job 3: SUMMARY - luÃ´n cháº¡y
  # ==========================================================
  summary:
    name: "ğŸ“Š Workflow Summary"
    runs-on: ubuntu-latest
    needs: [check, deploy]
    if: always()
    steps:
      - name: "ğŸš€ Workflow Status"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CI/CD Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
          echo ""
          
          if [ "${{ needs.check.result }}" == "success" ]; then
            echo "âœ… Check & Validate: PASSED"
          else
            echo "âŒ Check & Validate: FAILED"
          fi
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "âœ… Deployment: SUCCESS"
              echo "ğŸŒ Live at: https://metaboost.duckdns.org"
            elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
              echo "â­ï¸  Deployment: SKIPPED (not main branch)"
            else
              echo "âŒ Deployment: FAILED"
            fi
          else
            echo "â„¹ï¸  Deployment: SKIPPED (only deploys on main)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
